<?php
/**
 * Script de configura√ß√£o do ASAAS para PRODU√á√ÉO - VERS√ÉO CORRIGIDA
 * Execute este arquivo para configurar o ambiente de produ√ß√£o
 * 
 * IMPORTANTE: Execute apenas ap√≥s ter:
 * 1. Sua API Key de produ√ß√£o do ASAAS
 * 2. Um dom√≠nio real configurado (n√£o localhost/ngrok)
 * 3. SSL v√°lido no seu dom√≠nio
 */

require_once 'config/config.php';
require_once 'config/database.php';
require_once 'config/asaas_config.php';

echo "=== CONFIGURA√á√ÉO DO ASAAS PARA PRODU√á√ÉO - VERS√ÉO CORRIGIDA ===\n\n";

// Verificar se est√° em produ√ß√£o
if (ASAAS_ENVIRONMENT !== 'production') {
    echo "‚ùå ERRO: O ambiente n√£o est√° configurado para produ√ß√£o!\n";
    echo "Altere ASAAS_ENVIRONMENT para 'production' em config/asaas_config.php\n\n";
    exit(1);
}

// Verificar se a API Key de produ√ß√£o foi configurada
if (strpos(ASAAS_API_KEY_PRODUCTION, 'SUA_CHAVE') !== false) {
    echo "‚ùå ERRO: API Key de produ√ß√£o n√£o configurada!\n";
    echo "Configure ASAAS_API_KEY_PRODUCTION em config/asaas_config.php\n\n";
    exit(1);
}

// Verificar se a URL base est√° usando HTTPS
if (!str_starts_with(BASE_URL, 'https://')) {
    echo "‚ùå ERRO: URL base deve usar HTTPS em produ√ß√£o!\n";
    echo "URL atual: " . BASE_URL . "\n";
    echo "Configure BASE_URL com https:// em config/config.php\n\n";
    exit(1);
}

echo "‚úÖ Verifica√ß√µes iniciais passou!\n";
echo "üîß Iniciando configura√ß√£o...\n\n";

$asaas = new AsaasAPI();

// 1. Testar conex√£o com a API de produ√ß√£o
echo "1. Testando conex√£o com API de produ√ß√£o...\n";
$accountResult = $asaas->makeRequestPublic('GET', '/myAccount');

if (!$accountResult['success']) {
    echo "‚ùå Erro ao conectar com ASAAS produ√ß√£o:\n";
    echo "C√≥digo HTTP: " . $accountResult['http_code'] . "\n";
    echo "Resposta: " . json_encode($accountResult['data'], JSON_PRETTY_PRINT) . "\n\n";
    
    if ($accountResult['http_code'] == 401) {
        echo "üîë ERRO DE AUTENTICA√á√ÉO:\n";
        echo "Verifique se sua API Key de produ√ß√£o est√° correta\n";
    }
    exit(1);
}

echo "‚úÖ Conectado ao ASAAS produ√ß√£o com sucesso!\n";
$account = $accountResult['data'];
echo "üìã Conta: " . $account['name'] . " (" . $account['email'] . ")\n\n";

// 2. Configurar webhook de produ√ß√£o
echo "2. Configurando webhook de produ√ß√£o...\n";

$webhookUrl = ASAAS_WEBHOOK_URL;
echo "üåê URL do Webhook: $webhookUrl\n";

// Verificar se a URL do webhook √© acess√≠vel
echo "üîç Testando acessibilidade do webhook...\n";
$context = stream_context_create([
    "http" => [
        "method" => "GET",
        "timeout" => 10,
        "ignore_errors" => true
    ],
    "ssl" => [
        "verify_peer" => false,
        "verify_peer_name" => false
    ]
]);

$webhookTest = @file_get_contents($webhookUrl . '?test=1', false, $context);
if ($webhookTest === false) {
    echo "‚ö†Ô∏è  AVISO: N√£o foi poss√≠vel acessar a URL do webhook.\n";
    echo "Certifique-se de que $webhookUrl est√° acess√≠vel publicamente.\n\n";
} else {
    echo "‚úÖ Webhook acess√≠vel!\n\n";
}

// Remover webhooks antigos
echo "3. Limpando webhooks existentes...\n";
$result = $asaas->makeRequestPublic('GET', '/webhooks');

if ($result['success']) {
    $existingWebhooks = $result['data']['data'] ?? [];
    echo "üìã Webhooks existentes: " . count($existingWebhooks) . "\n";
    
    foreach ($existingWebhooks as $webhook) {
        echo "üóëÔ∏è  Removendo: " . $webhook['name'] . "\n";
        $deleteResult = $asaas->makeRequestPublic('DELETE', '/webhooks/' . $webhook['id']);
        if (!$deleteResult['success']) {
            echo "‚ö†Ô∏è  Aviso: N√£o foi poss√≠vel remover webhook " . $webhook['id'] . "\n";
        }
    }
}

// Criar novo webhook de produ√ß√£o COM OS CAMPOS OBRIGAT√ìRIOS
echo "\n4. Criando webhook de produ√ß√£o...\n";

$webhookData = [
    'name' => 'Discador.net Production Webhook',
    'url' => $webhookUrl,
    'email' => $account['email'], // Campo obrigat√≥rio que estava faltando
    'enabled' => true,
    'interrupted' => false, // Campo para poolInterrupted
    'sendType' => 'SEQUENTIALLY', // Campo obrigat√≥rio - tipo de envio
    'apiVersion' => ASAAS_WEBHOOK_API_VERSION,
    'authToken' => ASAAS_WEBHOOK_TOKEN,
    'events' => [
        'PAYMENT_CONFIRMED',
        'PAYMENT_RECEIVED', 
        'PAYMENT_OVERDUE',
        'PAYMENT_DELETED',
        'PAYMENT_CREATED'
    ]
];

echo "üìß Email configurado: " . $account['email'] . "\n";
echo "üîß Token de autentica√ß√£o: " . substr(ASAAS_WEBHOOK_TOKEN, 0, 20) . "...\n";

$createResult = $asaas->makeRequestPublic('POST', '/webhooks', $webhookData);

if ($createResult['success']) {
    echo "‚úÖ Webhook de produ√ß√£o configurado com sucesso!\n";
    echo "üÜî ID do Webhook: " . $createResult['data']['id'] . "\n";
    
    // Salvar configura√ß√£o no banco
    try {
        $stmt = $pdo->prepare("
            INSERT INTO configuracoes_sistema (chave, valor, descricao) 
            VALUES (?, ?, ?) 
            ON DUPLICATE KEY UPDATE valor = ?, updated_at = NOW()
        ");
        
        $stmt->execute([
            'asaas_webhook_configured', 
            '1', 
            'Webhook de produ√ß√£o configurado',
            '1'
        ]);
        
        $stmt->execute([
            'asaas_webhook_id', 
            $createResult['data']['id'], 
            'ID do webhook de produ√ß√£o',
            $createResult['data']['id']
        ]);
        
        $stmt->execute([
            'asaas_environment', 
            'production', 
            'Ambiente ASAAS atual',
            'production'
        ]);
        
        $stmt->execute([
            'asaas_webhook_email', 
            $account['email'], 
            'Email configurado no webhook',
            $account['email']
        ]);
        
        echo "‚úÖ Configura√ß√µes salvas no banco de dados!\n\n";
        
    } catch (Exception $e) {
        echo "‚ö†Ô∏è  Aviso: Erro ao salvar configura√ß√µes: " . $e->getMessage() . "\n\n";
    }
    
} else {
    echo "‚ùå Erro ao configurar webhook:\n";
    echo "C√≥digo HTTP: " . $createResult['http_code'] . "\n";
    
    if (isset($createResult['data']['errors'])) {
        foreach ($createResult['data']['errors'] as $error) {
            echo "- " . $error['description'] . "\n";
        }
    }
    
    echo "Resposta completa: " . $createResult['raw_response'] . "\n\n";
    exit(1);
}

// 5. Testar webhook criando uma cobran√ßa de teste
echo "5. Testando webhook...\n";
echo "üß™ Criando cobran√ßa de teste para validar webhook...\n";

// Criar cliente de teste
$testCustomer = [
    'name' => 'Cliente Teste Webhook Producao',
    'email' => 'teste.webhook.prod@' . parse_url(BASE_URL, PHP_URL_HOST),
    'cpfCnpj' => '11144477735', // CPF v√°lido para testes
    'externalReference' => 'webhook_test_prod_' . time()
];

$customerResult = $asaas->createOrUpdateCustomer($testCustomer);

if ($customerResult['success']) {
    $customerId = $customerResult['data']['id'];
    
    // Criar cobran√ßa de teste m√≠nima
    $testPayment = [
        'customer' => $customerId,
        'billingType' => 'PIX',
        'value' => 0.01, // 1 centavo para teste
        'dueDate' => date('Y-m-d', strtotime('+1 day')),
        'description' => 'Teste de webhook - produ√ß√£o',
        'externalReference' => 'webhook_test_prod_' . time()
    ];
    
    $paymentResult = $asaas->createPayment($testPayment);
    
    if ($paymentResult['success']) {
        echo "‚úÖ Cobran√ßa de teste criada: " . $paymentResult['data']['id'] . "\n";
        echo "üí∞ Valor: R$ 0,01 via PIX\n";
        echo "üìÖ Vencimento: " . $paymentResult['data']['dueDate'] . "\n";
        echo "üîó Status: " . $paymentResult['data']['status'] . "\n\n";
        
        // Salvar ID da cobran√ßa de teste
        try {
            $stmt = $pdo->prepare("
                INSERT INTO configuracoes_sistema (chave, valor, descricao) 
                VALUES (?, ?, ?) 
                ON DUPLICATE KEY UPDATE valor = ?, updated_at = NOW()
            ");
            $stmt->execute([
                'asaas_test_payment_id', 
                $paymentResult['data']['id'], 
                'ID da cobran√ßa de teste do webhook',
                $paymentResult['data']['id']
            ]);
        } catch (Exception $e) {
            // N√£o √© cr√≠tico se n√£o conseguir salvar
        }
        
    } else {
        echo "‚ö†Ô∏è  Aviso: N√£o foi poss√≠vel criar cobran√ßa de teste\n";
        echo "Motivo: " . json_encode($paymentResult['data']) . "\n\n";
    }
} else {
    echo "‚ö†Ô∏è  Aviso: N√£o foi poss√≠vel criar cliente de teste\n";
    echo "Motivo: " . json_encode($customerResult['data']) . "\n\n";
}

// 6. Verificar configura√ß√µes de seguran√ßa
echo "6. Verifica√ß√µes de seguran√ßa...\n";

// Verificar permiss√µes do arquivo de webhook
$webhookFile = __DIR__ . '/src/webhooks/asaas_webhook.php';
if (file_exists($webhookFile)) {
    $perms = fileperms($webhookFile);
    echo "üîí Permiss√µes do webhook: " . decoct($perms & 0777) . "\n";
    
    if (($perms & 0777) > 0644) {
        echo "‚ö†Ô∏è  AVISO: Permiss√µes muito abertas no arquivo webhook\n";
        echo "Recomenda√ß√£o: chmod 644 $webhookFile\n";
    }
} else {
    echo "‚ùå Arquivo de webhook n√£o encontrado: $webhookFile\n";
}

// Verificar se logs est√£o habilitados
if (ini_get('log_errors')) {
    echo "‚úÖ Logs de erro habilitados\n";
    echo "üìù Arquivo de log: " . (ini_get('error_log') ?: 'default') . "\n";
} else {
    echo "‚ö†Ô∏è  AVISO: Logs de erro desabilitados\n";
}

// Verificar se o diret√≥rio de logs existe
$logDir = dirname(ini_get('error_log'));
if (!empty($logDir) && !is_dir($logDir)) {
    echo "‚ö†Ô∏è  AVISO: Diret√≥rio de logs n√£o existe: $logDir\n";
}

echo "\n=== CONFIGURA√á√ÉO CONCLU√çDA ===\n\n";

echo "üìã RESUMO:\n";
echo "‚úÖ Ambiente: PRODU√á√ÉO\n";
echo "‚úÖ API Key: Configurada\n";
echo "‚úÖ Webhook: " . (isset($createResult) && $createResult['success'] ? "Configurado" : "Com problemas") . "\n";
echo "‚úÖ HTTPS: Ativo\n";
echo "‚úÖ Email: " . $account['email'] . "\n";
echo "‚úÖ Banco: Atualizado\n\n";

echo "üö® IMPORTANTE - PR√ìXIMOS PASSOS:\n";
echo "1. ‚úÖ Webhook configurado com sucesso!\n";
echo "2. üß™ Fa√ßa um teste real com valor baixo (ex: R$ 1,00)\n";
echo "3. üìä Monitore os logs para verificar se o webhook est√° funcionando\n";
echo "4. üîÑ Verifique se os cr√©ditos s√£o adicionados automaticamente\n";
echo "5. ‚è∞ Configure monitoramento de pagamentos pendentes\n\n";

echo "üìä MONITORAMENTO:\n";
$errorLog = ini_get('error_log') ?: '/var/log/php_errors.log';
echo "- Logs do sistema: tail -f $errorLog\n";
echo "- Webhook logs: SELECT * FROM webhook_logs ORDER BY processed_at DESC LIMIT 10;\n";
echo "- Transa√ß√µes: SELECT * FROM transacoes WHERE status_pagamento = 'Pendente';\n\n";

if (isset($paymentResult) && $paymentResult['success']) {
    echo "üß™ COBRAN√áA DE TESTE CRIADA:\n";
    echo "- ID: " . $paymentResult['data']['id'] . "\n";
    echo "- Status: " . $paymentResult['data']['status'] . "\n";
    echo "- URL PIX: " . ($paymentResult['data']['invoiceUrl'] ?? 'N/A') . "\n";
    echo "- Use esta cobran√ßa para testar o webhook\n\n";
}

echo "üéØ TESTE DO WEBHOOK:\n";
echo "Para testar se o webhook est√° funcionando:\n";
echo "1. Acesse: $webhookUrl?test=1\n";
echo "2. Deve retornar um JSON com status 'webhook_accessible'\n";
echo "3. Fa√ßa um pagamento de teste de R$ 1,00\n";
echo "4. Verifique os logs PHP em tempo real\n";
echo "5. Confirme se a transa√ß√£o foi processada automaticamente\n\n";

echo "‚ú® Sistema ASAAS configurado para produ√ß√£o com sucesso!\n";
echo "üéâ Seus clientes agora podem fazer pagamentos reais via PIX e Boleto\n\n";

// Limpar cache se necess√°rio
if (function_exists('opcache_reset')) {
    opcache_reset();
}
?>